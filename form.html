<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upah Tukang — Form</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/assets/css/extra.css">
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/index.html" class="text-sm text-slate-600">&larr; Beranda</a>
      <h1 class="text-lg font-semibold">Form Upah 7 Hari</h1>
      <div class="text-xs text-slate-500"><span id="saveState">Belum tersimpan</span></div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <section class="bg-white rounded-2xl shadow-sm p-4 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <div>
          <label class="block text-xs text-slate-500 mb-1">Periode (Mulai)</label>
          <input id="start" type="date" class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">s/d (Otomatis +6)</label>
          <input id="end" type="date" class="w-full border rounded-xl px-3 py-2" disabled>
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">Rumah</label>
          <input id="rumah" type="text" placeholder="BlokA-01" class="w-full border rounded-xl px-3 py-2">
        </div>
        <div class="flex items-end gap-2">
          <button id="btnSave" class="px-3 py-2 rounded-xl bg-slate-900 text-white">Simpan</button>
          <button id="btnClear" class="px-3 py-2 rounded-xl border">Kosongkan</button>
          <button id="btnExport" class="px-3 py-2 rounded-xl border">Export</button>
        </div>
      </div>
      <input id="key" type="hidden">
    </section>

    <section class="bg-white rounded-2xl shadow-sm p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-base font-semibold">Daftar Tukang (7 hari)</h2>
        <button id="btnAddRow" class="px-3 py-2 rounded-xl border">Tambah Baris</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm" id="tbl">
          <thead class="text-left text-slate-500">
            <tr>
              <th class="py-2 pr-3">Nama</th>
              <th class="py-2 pr-3">Tarif/Hari</th>
              <th class="py-2 pr-3">Hari Kerja</th>
              <th class="py-2 pr-3">Total</th>
              <th class="py-2 pr-3">Aksi</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="toast" class="toast bg-slate-900 text-white px-3 py-2 rounded-xl"></div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module">
    import { API, utils } from '/assets/js/config.js';
    const $ = (s)=>document.querySelector(s);
    const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500); };
    const setEnd = ()=> $('#end').value = utils.plusDaysISO($('#start').value, 6);

    const rowTpl = (r,i)=>`
      <tr data-i="${i}">
        <td class="py-2 pr-3"><input class="nm w-full border rounded-xl px-2 py-1" value="${r.nama||''}"></td>
        <td class="py-2 pr-3"><input class="tarif w-28 border rounded-xl px-2 py-1" type="number" min="0" value="${r.tarif||0}"></td>
        <td class="py-2 pr-3"><input class="hari w-20 border rounded-xl px-2 py-1" type="number" min="0" max="7" value="${r.hari||0}"></td>
        <td class="py-2 pr-3 total text-right">${utils.rupiah((+r.tarif||0)*(+r.hari||0))}</td>
        <td class="py-2 pr-3"><button class="btnDelRow px-2 py-1 rounded border border-red-300 text-red-600">Hapus</button></td>
      </tr>`;

    const data = { rows: [] };
    let dirty = false;
    const markSaved = (ok)=>$('#saveState').textContent = ok ? ('Tersimpan • '+new Date().toLocaleTimeString()) : 'Menyimpan…';

    function calcTotals(){
      document.querySelectorAll('#tbody tr').forEach(tr=>{
        const tarif = +tr.querySelector('.tarif').value||0;
        const hari = +tr.querySelector('.hari').value||0;
        tr.querySelector('.total').textContent = utils.rupiah(tarif*hari);
      });
    }

    function rebuildTable(){
      const tbody = $('#tbody');
      tbody.innerHTML = data.rows.map((r,i)=>rowTpl(r,i)).join('');
      calcTotals();
    }

    function restoreDefaultRow(){
      data.rows = [
        { nama:'', tarif:0, hari:0 }
      ];
      rebuildTable();
    }

    function collect(){
      const rows = Array.from(document.querySelectorAll('#tbody tr')).map(tr=>({
        nama: tr.querySelector('.nm').value.trim(),
        tarif: +tr.querySelector('.tarif').value||0,
        hari: +tr.querySelector('.hari').value||0
      }));
      const start = $('#start').value;
      const end = $('#end').value;
      const rumah = $('#rumah').value.trim();
      return { start, end, rumah, rows };
    }

    async function save(force=false){
      const v = collect();
      if(!v.start){ toast('Isi tanggal mulai'); return; }
      if(!$('#key').value){
        // buat key pertama kali
        const uid = new URL(location.href).searchParams.get('new') || utils.uuid();
        const rumahSeg = v.rumah ? v.rumah : '';
        const key = `ut:snap:${v.start}:${v.end}:${rumahSeg}:${uid}`;
        $('#key').value = key;
      }
      markSaved(false);
      const meta = { updatedAt: new Date().toISOString(), start:v.start, end:v.end, rumah:v.rumah };
      await API.set($('#key').value, v, meta);
      markSaved(true);
      dirty = false;
    }

    const debouncedSave = utils.debounce(()=>save(), 800);

    // events
    document.addEventListener('input', (e)=>{
      if(e.target.matches('#start')){ setEnd(); }
      if(e.target.closest('#tbody') || e.target.matches('#rumah') || e.target.matches('#start')){
        dirty = true; calcTotals(); debouncedSave();
      }
    });
    document.getElementById('btnSave').addEventListener('click', ()=>save(true));
    document.getElementById('btnClear').addEventListener('click', ()=>{ restoreDefaultRow(); dirty=true; debouncedSave(); });
    document.getElementById('btnAddRow').addEventListener('click', ()=>{ data.rows.push({nama:'',tarif:0,hari:0}); rebuildTable(); dirty=true; debouncedSave(); });
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const v = collect();
      const flat = v.rows.map((r,i)=>({ No:i+1, Nama:r.nama, Tarif:r.tarif, Hari:r.hari, Total:r.tarif*r.hari, Periode:`${v.start}→${v.end}`, Rumah:v.rumah }));
      const sheets = { 'Upah 7 Hari': flat };
      utils.toXLSX(`upah_${v.start}_${v.end}_${v.rumah||'NA'}.xlsx`, sheets);
    });

    // init
    const url = new URL(location.href);
    const key = url.searchParams.get('key');
    const startQ = url.searchParams.get('start');
    const endQ = url.searchParams.get('end');

    $('#start').value = startQ || utils.todayISO();
    setEnd();
    if(endQ){ $('#end').value = endQ; }

    if(key){
      API.get(key).then(res=>{
        if(res && res.value){
          $('#key').value = key;
          $('#start').value = res.value.start || $('#start').value;
          $('#end').value = res.value.end || $('#end').value;
          $('#rumah').value = res.value.rumah || '';
          data.rows = Array.isArray(res.value.rows) ? res.value.rows : [];
          if(!data.rows.length) restoreDefaultRow(); else rebuildTable();
          markSaved(true);
        } else {
          restoreDefaultRow();
        }
      }).catch(()=>restoreDefaultRow());
    } else {
      restoreDefaultRow();
    }
  </script>
</body>
</html>
