<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upah Tukang — Form 7 Hari</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/extra.css">
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-20 border-b bg-white/90 backdrop-blur">
    <div class="mx-auto flex max-w-6xl flex-wrap items-center justify-between gap-3 px-4 py-3">
      <div class="flex items-center gap-3">
        <a href="/index.html" class="rounded-xl border border-transparent px-3 py-2 text-sm text-slate-500 transition hover:border-slate-200 hover:text-slate-700">&larr; Beranda</a>
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-400">Upah Tukang</p>
          <h1 class="text-lg font-semibold">Form 7 Hari</h1>
        </div>
      </div>
      <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
        <span id="saveState" class="rounded-full bg-emerald-100 px-3 py-1 font-medium text-emerald-700">Siap</span>
        <span id="offline" class="hidden rounded-full bg-red-100 px-3 py-1 font-medium text-red-600">Offline</span>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl space-y-8 px-4 py-6">
    <section class="rounded-2xl bg-white p-6 shadow-sm">
      <div class="grid gap-4 md:grid-cols-4">
        <label class="flex flex-col gap-1 text-sm">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Periode (Mulai)</span>
          <input id="periodStart" type="date" class="rounded-xl border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-200" required>
        </label>
        <label class="flex flex-col gap-1 text-sm">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">s/d (otomatis +6)</span>
          <input id="periodEnd" type="date" class="rounded-xl border border-slate-200 px-3 py-2 text-sm text-slate-700 bg-slate-50" readonly>
        </label>
        <label class="flex flex-col gap-1 text-sm">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Rumah</span>
          <input id="rumah" type="text" placeholder="BlokA-01" class="rounded-xl border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-200">
        </label>
        <div class="flex flex-wrap items-center justify-end gap-2">
          <button id="btnSave" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-500">Simpan</button>
          <button id="btnClear" class="rounded-xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 hover:border-slate-300">Kosongkan</button>
        </div>
      </div>
      <div class="mt-4 flex flex-wrap items-center gap-2 text-xs text-slate-500">
        <input id="key" type="hidden">
        <button id="btnExportXLSX" class="rounded-xl border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-600 hover:border-slate-300">Export XLSX</button>
        <button id="btnExportCSV" class="rounded-xl border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-600 hover:border-slate-300">Export CSV</button>
        <label for="importCsv" class="cursor-pointer rounded-xl border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-600 hover:border-slate-300">Import CSV</label>
        <input id="importCsv" type="file" accept=".csv" class="hidden">
        <span class="text-slate-300">|</span>
        <span id="lastSaved" class="text-xs text-slate-400">—</span>
      </div>
    </section>

    <section class="space-y-4 rounded-2xl bg-white p-6 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-base font-semibold text-slate-900">Daftar Tukang</h2>
          <p class="text-xs text-slate-500">Isi tarif per hari dan jumlah hari kerja (maksimal 7 hari).</p>
        </div>
        <button id="btnAddRow" class="rounded-xl border border-slate-200 px-3 py-2 text-sm font-medium text-slate-600 hover:border-slate-300">Tambah Baris</button>
      </div>
      <div id="tableWrap" class="table-scroll">
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-500">
            <tr>
              <th class="py-2 pr-3 font-medium">Nama</th>
              <th class="py-2 pr-3 font-medium">Tarif/Hari</th>
              <th class="py-2 pr-3 font-medium">Hari Kerja</th>
              <th class="py-2 pr-3 font-medium text-right">Total</th>
              <th class="py-2 pr-3 font-medium text-right">Aksi</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
      <div class="grid gap-3 md:grid-cols-3">
        <div class="rounded-2xl bg-slate-50 p-4">
          <p class="text-xs uppercase tracking-wide text-slate-400">Total Baris</p>
          <p id="totalRows" class="text-xl font-semibold text-slate-800">0</p>
        </div>
        <div class="rounded-2xl bg-slate-50 p-4">
          <p class="text-xs uppercase tracking-wide text-slate-400">Total Hari Kerja</p>
          <p id="totalDays" class="text-xl font-semibold text-slate-800">0</p>
        </div>
        <div class="rounded-2xl bg-slate-50 p-4">
          <p class="text-xs uppercase tracking-wide text-slate-400">Total Upah</p>
          <p id="totalAmount" class="text-xl font-semibold text-slate-800">Rp0</p>
        </div>
      </div>
    </section>
  </main>

  <footer class="border-t bg-white/80 py-4">
    <div class="mx-auto flex max-w-6xl flex-col gap-2 px-4 text-xs text-slate-500 md:flex-row md:items-center md:justify-between">
      <span>&copy; <span id="year"></span> Upah Tukang</span>
      <span>Autosave aktif • Data tersimpan di <code>UPAH_KV</code></span>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js" integrity="sha384-QfX1QE4G6dxj7hjz9YZhhGZgxUwZjAyNWBo2fZK8Fn0vIUtS7gPAOfpRJ4VCJ06Y" crossorigin="anonymous"></script>
    <script type="module">
    import {
      utils,
      showToast,
      formatError,
      readStorageRoot,
      createDefaultItem,
      cloneDefaultRows,
      bootRatesUI,
      renderRumah,
      bootBerasUI,
      rerender,
      addWorker,
      restoreDefaultRows,
      updatePeriod,
      syncPeriodInputs,
      applySnapshotDataset,
      saveAll,
      downloadCSV,
      downloadXLSX,
      ensureApiClient,
      collectRows
    } from '/assets/js/upah-core.js';

    const YEAR = new Date().getFullYear();
    document.getElementById('year').textContent = YEAR;

    const ctx = {
      state: createDefaultItem({ rows: cloneDefaultRows() }),
      dom: {
        periodStart: document.getElementById('periodStart'),
        periodEnd: document.getElementById('periodEnd'),
        rumahInput: document.getElementById('rumah'),
        tbody: document.getElementById('tbody'),
        totalRows: document.getElementById('totalRows'),
        totalDays: document.getElementById('totalDays'),
        totalAmount: document.getElementById('totalAmount')
      }
    };

    const saveState = document.getElementById('saveState');
    const lastSaved = document.getElementById('lastSaved');
    const offlineBadge = document.getElementById('offline');
    const hiddenKey = document.getElementById('key');

    ctx.state.dirty = false;
    ctx.state.saving = false;
    ctx.state.loaded = false;

    function setOffline(isOffline) {
      offlineBadge.classList.toggle('hidden', !isOffline);
    }

    function markSaving(pending) {
      ctx.state.saving = pending;
      if (pending) {
        saveState.textContent = 'Menyimpan…';
        saveState.className = 'rounded-full bg-amber-100 px-3 py-1 font-medium text-amber-700';
      } else if (!ctx.state.dirty) {
        saveState.textContent = 'Tersimpan';
        saveState.className = 'rounded-full bg-emerald-100 px-3 py-1 font-medium text-emerald-700';
      } else {
        markDirty();
      }
    }

    function markDirty() {
      ctx.state.dirty = true;
      ctx.state.saving = false;
      saveState.textContent = 'Draft belum tersimpan';
      saveState.className = 'rounded-full bg-slate-200 px-3 py-1 font-medium text-slate-700';
    }

    function refreshSummaryFromDom() {
      const rows = collectRows(ctx);
      if (ctx.dom.totalRows) {
        ctx.dom.totalRows.textContent = utils.formatNumber(rows.length);
      }
      if (ctx.dom.totalDays) {
        ctx.dom.totalDays.textContent = utils.formatNumber(utils.sumDays(rows));
      }
      if (ctx.dom.totalAmount) {
        ctx.dom.totalAmount.textContent = utils.formatRupiah(utils.sumRows(rows));
      }
    }

    function syncRowsToState() {
      ctx.state.rows = collectRows(ctx);
    }

    async function handleSave(manual = false, { notifyFallback = manual } = {}) {
      try {
        markSaving(true);
        await saveAll(ctx, { manual, notifyFallback });
        ctx.state.dirty = false;
        markSaving(false);
        hiddenKey.value = ctx.state.key || '';
        lastSaved.textContent = `Tersimpan ${new Date().toLocaleTimeString('id-ID')}`;
      } catch (err) {
        markSaving(false);
        markDirty();
        if (!manual) {
          console.warn('autosave gagal', err);
        }
        throw err;
      }
    }

    const debouncedSave = utils.debounce(() => {
      if (!ctx.state.loaded) return;
      if (!navigator.onLine) {
        markDirty();
        return;
      }
      syncRowsToState();
      handleSave(false, { notifyFallback: false }).catch(() => {});
    }, 800);

    async function loadFromKey(key) {
      const api = ensureApiClient();
      try {
        markSaving(true);
        const res = await api.loadData(key);
        if (!res || !res.value) {
          throw new Error('Data tidak ditemukan');
        }
        ctx.state.key = key;
        hiddenKey.value = key;
        applySnapshotDataset(ctx, { ...res.value, key, meta: res.meta || {} });
        lastSaved.textContent = res.meta?.updatedAt ? `Terakhir ${new Date(res.meta.updatedAt).toLocaleString('id-ID')}` : '—';
        ctx.state.dirty = false;
      } catch (err) {
        showToast(formatError(err), 'error');
        restoreDefaultRows(ctx);
      } finally {
        markSaving(false);
        ctx.state.loaded = true;
      }
    }

    function tryLoadSnapshotParam(param) {
      if (!param) return false;
      try {
        const decoded = JSON.parse(atob(decodeURIComponent(param)));
        ctx.state.key = decoded.key || ctx.state.key;
        if (ctx.state.key) hiddenKey.value = ctx.state.key;
        applySnapshotDataset(ctx, decoded, { persist: true });
        ctx.state.loaded = true;
        lastSaved.textContent = decoded?.meta?.updatedAt ? `Terakhir ${new Date(decoded.meta.updatedAt).toLocaleString('id-ID')}` : 'Snapshot dimuat';
        return true;
      } catch (err) {
        console.warn('gagal decode snapshot', err);
        showToast('Snapshot tidak valid', 'error');
        return false;
      }
    }

    function tryLoadHistory(histKey) {
      if (!histKey) return false;
      const root = readStorageRoot();
      let entry = null;
      if (root.items[histKey]) {
        entry = { key: histKey, value: root.items[histKey] };
      } else {
        const found = Object.entries(root.items).find(([, item]) => item.periodStart === histKey || item.periodEnd === histKey);
        if (found) {
          entry = { key: found[0], value: found[1] };
        }
      }
      if (!entry) return false;
      ctx.state.key = entry.key;
      hiddenKey.value = entry.key;
      applySnapshotDataset(ctx, { ...entry.value, key: entry.key }, { persist: false });
      ctx.state.loaded = true;
      lastSaved.textContent = 'Draft lokal dimuat';
      return true;
    }

    async function initFromQuery() {
      bootRatesUI(ctx);
      bootBerasUI(ctx);
      renderRumah(ctx);
      rerender(ctx);

      const params = new URLSearchParams(window.location.search);
      const keyParam = params.get('key');
      const snapshotParam = params.get('snapshot');
      const histParam = params.get('hist');
      const startParam = params.get('start');
      const endParam = params.get('end');

      if (window.__UPAH_DATA__) {
        applySnapshotDataset(ctx, window.__UPAH_DATA__, { persist: false });
      }

      if (keyParam) {
        await loadFromKey(keyParam);
        return;
      }

      if (snapshotParam && tryLoadSnapshotParam(snapshotParam)) {
        return;
      }

      if (histParam && tryLoadHistory(histParam)) {
        return;
      }

      const root = readStorageRoot();
      if (root.lastKey && root.items[root.lastKey]) {
        ctx.state.key = root.lastKey;
        hiddenKey.value = ctx.state.key;
        applySnapshotDataset(ctx, { ...root.items[root.lastKey], key: ctx.state.key }, { persist: false });
        ctx.state.loaded = true;
        lastSaved.textContent = 'Draft lokal dimuat';
        return;
      }

      const startValue = startParam || utils.todayISO();
      const endValue = endParam || utils.plusDaysISO(startValue, 6);
      ctx.state.periodStart = startValue;
      ctx.state.periodEnd = endValue;
      syncPeriodInputs(ctx);
      renderRumah(ctx);
      rerender(ctx);
      ctx.state.loaded = true;
    }

    document.addEventListener('input', (event) => {
      if (event.target.matches('#periodStart')) {
        updatePeriod(ctx);
        syncPeriodInputs(ctx);
        markDirty();
        refreshSummaryFromDom();
        debouncedSave();
        return;
      }
      if (event.target.matches('#rumah')) {
        markDirty();
        refreshSummaryFromDom();
        debouncedSave();
        return;
      }
      if (event.target.closest('table')) {
        markDirty();
        refreshSummaryFromDom();
        debouncedSave();
      }
    });

    document.getElementById('tbody').addEventListener('click', (event) => {
      if (event.target.matches('.btnDelRow')) {
        event.preventDefault();
        const tr = event.target.closest('tr');
        const index = Number(tr.dataset.index);
        syncRowsToState();
        if (ctx.state.rows.length <= 1) {
          showToast('Minimal satu baris data', 'warning');
          return;
        }
        ctx.state.rows.splice(index, 1);
        rerender(ctx);
        markDirty();
        refreshSummaryFromDom();
        debouncedSave();
      }
    });

    document.getElementById('btnAddRow').addEventListener('click', () => {
      syncRowsToState();
      addWorker(ctx);
      markDirty();
      refreshSummaryFromDom();
      debouncedSave();
    });

    document.getElementById('btnClear').addEventListener('click', () => {
      if (!window.confirm('Kosongkan tabel? Data tersimpan tidak dihapus.')) return;
      restoreDefaultRows(ctx);
      markDirty();
      refreshSummaryFromDom();
    });

    document.getElementById('btnSave').addEventListener('click', () => {
      syncRowsToState();
      handleSave(true, { notifyFallback: true }).catch((err) => {
        console.error('gagal menyimpan manual', err);
      });
    });

    document.getElementById('btnExportXLSX').addEventListener('click', () => {
      try {
        syncRowsToState();
        downloadXLSX(ctx);
        showToast('Berhasil membuat file XLSX', 'success');
      } catch (err) {
        showToast(formatError(err), 'error');
      }
    });

    document.getElementById('btnExportCSV').addEventListener('click', () => {
      try {
        syncRowsToState();
        downloadCSV(ctx);
        showToast('Berhasil membuat file CSV', 'success');
      } catch (err) {
        showToast(formatError(err), 'error');
      }
    });

    document.getElementById('importCsv').addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = String(e.target?.result || '');
          const parsed = utils.parseCSV(text);
          if (!parsed.rows.length) {
            throw new Error('File CSV kosong');
          }
          ctx.state.rows = parsed.rows.map((row) => ({
            nama: row.Nama || row.nama || '',
            tarif: Number(row.Tarif ?? row.tarif ?? 0) || 0,
            hari: Number(row.Hari ?? row.hari ?? 0) || 0
          }));
          rerender(ctx);
          markDirty();
          refreshSummaryFromDom();
          debouncedSave();
          showToast('Data CSV dimuat', 'success');
        } catch (err) {
          showToast(formatError(err), 'error');
        }
      };
      reader.onerror = () => showToast('Gagal membaca file CSV', 'error');
      reader.readAsText(file);
      event.target.value = '';
    });

    window.addEventListener('online', () => {
      setOffline(false);
      if (ctx.state.dirty) {
        debouncedSave();
      }
    });
    window.addEventListener('offline', () => setOffline(true));

    await initFromQuery();
    setOffline(!navigator.onLine);
    refreshSummaryFromDom();
  </script>

</body>
</html>
