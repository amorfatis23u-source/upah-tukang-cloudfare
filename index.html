<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upah Tukang — Beranda</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/assets/css/extra.css">
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-semibold">Upah Tukang</h1>
      <nav class="flex gap-2">
        <a href="/rekap.html" class="px-3 py-2 rounded-xl border">Rekap</a>
        <button id="btnNew" class="px-3 py-2 rounded-xl text-white bg-orange-500 hover:bg-orange-600">Form Baru</button>
      </nav>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <section class="bg-white rounded-2xl shadow-sm p-4">
      <h2 class="text-lg font-semibold mb-3">Terakhir Disimpan</h2>
      <div id="listWrap" class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-500">
            <tr>
              <th class="py-2 pr-4">Periode</th>
              <th class="py-2 pr-4">Rumah</th>
              <th class="py-2 pr-4">Updated</th>
              <th class="py-2 pr-4">Aksi</th>
            </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>
        <div class="flex items-center gap-2 mt-3">
          <button id="prev" class="px-3 py-1 rounded border">Prev</button>
          <button id="next" class="px-3 py-1 rounded border">Next</button>
          <span id="cursorInfo" class="text-xs text-slate-500"></span>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast bg-slate-900 text-white px-3 py-2 rounded-xl"></div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module">
    import { API, utils } from '/assets/js/config.js';

    const toast = (msg)=>{
      const el = document.getElementById('toast');
      el.textContent = msg; el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'), 2000);
    };

    // "Form Baru" → form.html?new={uuid}&start=today&sampai=+6
    document.getElementById('btnNew').addEventListener('click', ()=>{
      const start = utils.todayISO();
      const end = utils.plusDaysISO(start, 6);
      const id = utils.uuid();
      const u = new URL('/form.html', location.origin);
      u.searchParams.set('new', id);
      u.searchParams.set('start', start);
      u.searchParams.set('end', end);
      location.href = u.toString();
    });

    let cursor = '';
    async function loadList(){
      const { ok, keys, cursor: c, list_complete } = await API.list('ut:snap:', cursor);
      const body = document.getElementById('listBody');
      body.innerHTML = '';
      (keys||[]).slice(0,10).forEach(k=>{
        // Expect name like ut:snap:YYYY-MM-DD:YYYY-MM-DD:rumah:uuid
        const parts = (k.name||'').split(':');
        const periode = parts[2] && parts[3] ? `${parts[2]} → ${parts[3]}` : '—';
        const rumah = parts[4] || '—';
        const updated = (k.metadata && k.metadata.updatedAt) ? new Date(k.metadata.updatedAt).toLocaleString() : '—';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 pr-4">${periode}</td>
          <td class="py-2 pr-4">${rumah}</td>
          <td class="py-2 pr-4">${updated}</td>
          <td class="py-2 pr-4">
            <a class="px-2 py-1 rounded border" href="/form.html?key=${encodeURIComponent(k.name)}">Buka</a>
            <button data-key="${k.name}" class="btnDel px-2 py-1 rounded border border-red-300 text-red-600">Hapus</button>
          </td>
        `;
        body.appendChild(tr);
      });
      document.getElementById('cursorInfo').textContent = list_complete ? 'last page' : (c ? `cursor: ${c.slice(0,8)}...` : '');
      // Save next cursor
      window._nextCursor = c || '';
    }

    document.getElementById('prev').addEventListener('click', ()=>{
      toast('Cursor backward tidak disimpan (demo).');
    });
    document.getElementById('next').addEventListener('click', ()=>{
      cursor = window._nextCursor || '';
      loadList();
    });

    document.addEventListener('click', async (e)=>{
      if(e.target.matches('.btnDel')){
        const key = e.target.getAttribute('data-key');
        if(confirm('Hapus data ini?')){
          await API.del(key);
          toast('Dihapus');
          loadList();
        }
      }
    });

    loadList().catch(err=>toast(err.message));
  </script>
</body>
</html>
