<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upah Tukang — Rekap</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/assets/css/extra.css">
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/index.html" class="text-sm text-slate-600">&larr; Beranda</a>
      <h1 class="text-lg font-semibold">Rekap</h1>
      <div class="flex gap-2">
        <input id="qRumah" placeholder="Cari rumah..." class="border rounded-xl px-3 py-2 text-sm">
        <button id="btnExport" class="px-3 py-2 rounded-xl border">Export</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <section class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="bg-white rounded-2xl shadow-sm p-4">
        <div class="text-xs text-slate-500">Rekap Total</div>
        <div class="text-2xl font-semibold" id="sumTotal">Rp0</div>
      </div>
      <div class="bg-white rounded-2xl shadow-sm p-4">
        <div class="text-xs text-slate-500">Jumlah Snapshot</div>
        <div class="text-2xl font-semibold" id="sumCount">0</div>
      </div>
    </section>

    <section class="bg-white rounded-2xl shadow-sm p-4">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-500">
            <tr>
              <th class="py-2 pr-3">Periode</th>
              <th class="py-2 pr-3">Rumah</th>
              <th class="py-2 pr-3">Total (calc)</th>
              <th class="py-2 pr-3">Updated</th>
              <th class="py-2 pr-3">Aksi</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="flex items-center gap-2 mt-3">
        <button id="prev" class="px-3 py-1 rounded border">Prev</button>
        <button id="next" class="px-3 py-1 rounded border">Next</button>
        <span id="cursorInfo" class="text-xs text-slate-500"></span>
      </div>
    </section>
  </main>

  <div id="toast" class="toast bg-slate-900 text-white px-3 py-2 rounded-xl"></div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module">
    import { API, utils } from '/assets/js/config.js';
    const $ = (s)=>document.querySelector(s);
    const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500); };

    let cursor = '';
    let cache = []; // flat rows for export

    function rowTotal(v){
      if(!v || !Array.isArray(v.rows)) return 0;
      return v.rows.reduce((s,r)=>s + (+r.tarif||0)*(+r.hari||0), 0);
    }

    async function loadPage(){
      const { ok, keys, cursor: c, list_complete } = await API.list('ut:snap:', cursor);
      $('#tbody').innerHTML = '';
      cache = [];
      for(const k of (keys||[])){
        // optional client-side filter by rumah
        const rumahQ = $('#qRumah').value.trim().toLowerCase();
        const periode = (()=>{
          const parts = (k.name||'').split(':');
          return parts[2] && parts[3] ? `${parts[2]}→${parts[3]}` : '—';
        })();
        const rumah = (()=>{
          const parts = (k.name||'').split(':');
          return parts[4] || '';
        })();
        if(rumahQ && !String(rumah).toLowerCase().includes(rumahQ)) continue;

        // Load detail to calc totals
        let total = 0, value = null;
        try {
          const res = await API.get(k.name);
          value = res.value || null;
          total = rowTotal(value);
        } catch(e){ total = 0; }

        const updated = (k.metadata && k.metadata.updatedAt) ? new Date(k.metadata.updatedAt).toLocaleString() : '—';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 pr-3">${periode}</td>
          <td class="py-2 pr-3">${rumah||'—'}</td>
          <td class="py-2 pr-3 text-right">${utils.rupiah(total)}</td>
          <td class="py-2 pr-3">${updated}</td>
          <td class="py-2 pr-3">
            <a class="px-2 py-1 rounded border" href="/form.html?key=${encodeURIComponent(k.name)}">Buka</a>
            <button data-key="${k.name}" class="btnDel px-2 py-1 rounded border border-red-300 text-red-600">Hapus</button>
          </td>
        `;
        $('#tbody').appendChild(tr);

        // push to export cache
        cache.push({
          Key: k.name,
          Periode: periode.replace('→','->'),
          Rumah: rumah,
          Total: total,
          UpdatedAt: (k.metadata && k.metadata.updatedAt) || ''
        });
      }

      // summary
      const sum = cache.reduce((s,r)=>s + (+r.Total||0), 0);
      $('#sumTotal').textContent = utils.rupiah(sum);
      $('#sumCount').textContent = String(cache.length);
      $('#cursorInfo').textContent = list_complete ? 'last page' : (c ? `cursor: ${c.slice(0,8)}...` : '');
      window._nextC = c || '';
    }

    document.getElementById('prev').addEventListener('click', ()=>toast('Cursor backward tidak disimpan (demo).'));
    document.getElementById('next').addEventListener('click', ()=>{ cursor = window._nextC || ''; loadPage(); });
    document.getElementById('btnExport').addEventListener('click', ()=>{
      if(!cache.length){ toast('Tidak ada data.'); return; }
      utils.toXLSX('rekap_upah.xlsx', { 'Rekap': cache });
    });
    document.getElementById('qRumah').addEventListener('input', ()=>loadPage());

    document.addEventListener('click', async (e)=>{
      if(e.target.matches('.btnDel')){
        const key = e.target.getAttribute('data-key');
        if(confirm('Hapus data ini?')){
          await API.del(key);
          toast('Dihapus');
          loadPage();
        }
      }
    });

    loadPage().catch(err=>toast(err.message));
  </script>
</body>
</html>
